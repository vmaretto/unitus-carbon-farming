<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario e Syllabus - Master in Carbon Farming</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --green-900: #0f2419;
            --green-800: #1b3a2d;
            --green-700: #245a3d;
            --green-600: #2c7a4b;
            --green-500: #38a169;
            --green-400: #68d391;
            --green-300: #9ae6b4;
            --green-200: #c6f6d5;
            --green-100: #f0fff4;
            --orange-500: #ff7a1a;
            --orange-400: #ff9a4d;
            --orange-100: #fff7ed;
            --blue-600: #2563eb;
            --blue-100: #dbeafe;
            --purple-600: #7c3aed;
            --purple-100: #ede9fe;
            --gray-900: #111827;
            --gray-800: #1f2937;
            --gray-700: #374151;
            --gray-600: #4b5563;
            --gray-500: #6b7280;
            --gray-400: #9ca3af;
            --gray-300: #d1d5db;
            --gray-200: #e5e7eb;
            --gray-100: #f3f4f6;
            --gray-50: #f9fafb;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--green-800) 0%, var(--green-600) 100%);
            padding: 32px 24px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-link {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .back-link:hover { color: white; }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            margin: 0;
        }

        /* Main Navigation Tabs */
        .main-tabs {
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 6px;
            border-radius: 16px;
            width: fit-content;
        }

        .main-tabs button {
            padding: 12px 28px;
            border: none;
            background: transparent;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        .main-tabs button.active {
            background: white;
            color: var(--green-700);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .main-tabs button:not(.active):hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px 60px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ============ CALENDARIO ============ */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            background: white;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--gray-700);
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--green-100);
            border-color: var(--green-300);
        }

        .month-label {
            font-size: 1.6rem;
            font-weight: 700;
            min-width: 220px;
            text-align: center;
        }

        .view-buttons {
            display: flex;
            gap: 8px;
        }

        .view-buttons button {
            padding: 10px 20px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-buttons button.active {
            background: var(--green-600);
            color: white;
            border-color: var(--green-600);
        }

        /* Calendar Grid - Improved */
        .calendar-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .weekdays div {
            text-align: center;
            font-weight: 700;
            color: var(--gray-500);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 16px 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            min-height: 140px;
            padding: 10px;
            border-right: 1px solid var(--gray-100);
            border-bottom: 1px solid var(--gray-100);
            background: white;
            transition: background 0.2s;
            position: relative;
        }

        .calendar-day:nth-child(7n) { border-right: none; }

        .calendar-day:hover { background: var(--gray-50); }

        .calendar-day.other-month {
            background: var(--gray-50);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--green-50);
        }

        .calendar-day.today .day-number {
            background: var(--green-600);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-number {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .day-lessons {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Lesson Card in Calendar */
        .lesson-mini {
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid;
        }

        .lesson-mini:hover {
            transform: translateX(2px);
        }

        .lesson-mini.module-1 { background: var(--green-100); border-color: var(--green-600); }
        .lesson-mini.module-2 { background: var(--blue-100); border-color: var(--blue-600); }
        .lesson-mini.module-3 { background: var(--purple-100); border-color: var(--purple-600); }
        .lesson-mini.module-4 { background: var(--orange-100); border-color: var(--orange-500); }
        .lesson-mini.module-default { background: var(--gray-100); border-color: var(--gray-500); }

        .lesson-mini .lesson-time {
            font-weight: 700;
            color: var(--gray-700);
        }

        .lesson-mini .lesson-title {
            font-weight: 600;
            color: var(--gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lesson-mini .lesson-info {
            color: var(--gray-500);
            font-size: 0.65rem;
            margin-top: 2px;
            display: flex;
            gap: 8px;
        }

        .more-indicator {
            font-size: 0.7rem;
            color: var(--gray-500);
            font-weight: 600;
            padding: 4px;
            text-align: center;
        }

        /* List View */
        .list-container { display: none; }
        .list-container.active { display: block; }
        .calendar-container.hidden { display: none; }

        .lesson-list-item {
            background: white;
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 20px;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--gray-100);
            cursor: pointer;
            transition: all 0.2s;
        }

        .lesson-list-item:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .list-date {
            text-align: center;
        }

        .list-date .day {
            font-size: 2rem;
            font-weight: 800;
            color: var(--green-600);
            line-height: 1;
        }

        .list-date .weekday {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .list-info h3 {
            margin: 0 0 6px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .list-info .module-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .module-badge.m1 { background: var(--green-100); color: var(--green-700); }
        .module-badge.m2 { background: var(--blue-100); color: var(--blue-600); }
        .module-badge.m3 { background: var(--purple-100); color: var(--purple-600); }
        .module-badge.m4 { background: var(--orange-100); color: var(--orange-500); }

        .list-meta {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .list-time {
            text-align: right;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        /* ============ SYLLABUS ============ */
        .syllabus-intro {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
        }

        .syllabus-intro h2 {
            margin: 0 0 12px;
            font-size: 1.5rem;
        }

        .syllabus-intro p {
            margin: 0;
            color: var(--gray-600);
            line-height: 1.7;
        }

        .syllabus-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .stat-box {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--green-600);
        }

        .stat-box .label {
            font-size: 0.85rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        /* Module Cards */
        .modules-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .module-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-100);
        }

        .module-header {
            padding: 24px 28px;
            cursor: pointer;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            transition: background 0.2s;
        }

        .module-header:hover { background: var(--gray-50); }

        .module-number {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 800;
            color: white;
        }

        .module-number.m1 { background: linear-gradient(135deg, var(--green-600), var(--green-500)); }
        .module-number.m2 { background: linear-gradient(135deg, var(--blue-600), #3b82f6); }
        .module-number.m3 { background: linear-gradient(135deg, var(--purple-600), #8b5cf6); }
        .module-number.m4 { background: linear-gradient(135deg, var(--orange-500), var(--orange-400)); }

        .module-title-section h3 {
            margin: 0 0 8px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .module-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .module-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .module-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .module-toggle:hover { background: var(--gray-200); }
        .module-card.expanded .module-toggle { transform: rotate(180deg); }

        .module-content {
            display: none;
            border-top: 1px solid var(--gray-100);
        }

        .module-card.expanded .module-content { display: block; }

        .module-section {
            padding: 24px 28px;
            border-bottom: 1px solid var(--gray-100);
        }

        .module-section:last-child { border-bottom: none; }

        .module-section h4 {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gray-400);
            margin: 0 0 12px;
        }

        .module-section p {
            margin: 0;
            line-height: 1.7;
            color: var(--gray-700);
        }

        .module-section ul {
            margin: 0;
            padding-left: 20px;
            color: var(--gray-700);
            line-height: 1.8;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .hour-item {
            background: var(--gray-50);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .hour-item .value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--green-600);
        }

        .hour-item .label {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .teachers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .teacher-tag {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-50);
            padding: 10px 16px;
            border-radius: 10px;
        }

        .teacher-tag .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--green-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--green-700);
            font-size: 0.85rem;
        }

        .teacher-tag .name {
            font-weight: 600;
            color: var(--gray-800);
        }

        /* Module Lessons */
        .module-lessons {
            background: var(--gray-50);
        }

        .module-lesson-item {
            display: flex;
            gap: 16px;
            padding: 16px 28px;
            border-bottom: 1px solid var(--gray-200);
            align-items: center;
        }

        .module-lesson-item:last-child { border-bottom: none; }

        .lesson-date-badge {
            background: white;
            padding: 10px 14px;
            border-radius: 10px;
            text-align: center;
            min-width: 60px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .lesson-date-badge .day {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--green-600);
        }

        .lesson-date-badge .month {
            font-size: 0.7rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .lesson-details {
            flex: 1;
        }

        .lesson-details .title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .lesson-details .meta {
            font-size: 0.85rem;
            color: var(--gray-500);
            display: flex;
            gap: 16px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 24px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4);
            position: relative;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 10;
        }

        .modal-header {
            padding: 28px 28px 0;
        }

        .modal-module-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 6px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 0;
        }

        .modal-body { padding: 24px 28px 28px; }

        .modal-datetime {
            display: flex;
            gap: 20px;
            padding: 18px 20px;
            background: linear-gradient(135deg, var(--green-600), var(--green-500));
            border-radius: 14px;
            margin-bottom: 24px;
            color: white;
            flex-wrap: wrap;
        }

        .modal-datetime-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .modal-details {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-detail-row {
            display: flex;
            gap: 14px;
        }

        .modal-detail-row .icon { width: 24px; text-align: center; font-size: 1.1rem; }
        .modal-detail-row .content { flex: 1; }
        .modal-detail-row .label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            margin-bottom: 4px;
        }
        .modal-detail-row .value { color: var(--gray-800); font-weight: 500; }
        .modal-detail-row .value a { color: var(--green-600); text-decoration: none; font-weight: 600; }

        .modal-description {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }

        .modal-description h4 {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray-400);
            margin: 0 0 10px;
        }

        .modal-description p {
            margin: 0;
            color: var(--gray-700);
            line-height: 1.7;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 24px;
            color: var(--gray-400);
        }

        .empty-state h3 { color: var(--gray-600); margin: 0 0 8px; }

        /* Responsive */
        @media (max-width: 900px) {
            .header h1 { font-size: 1.4rem; }
            .main-tabs button { padding: 10px 20px; font-size: 0.85rem; }
        }

        @media (max-width: 768px) {
            .calendar-header { flex-direction: column; align-items: stretch; }
            .calendar-nav { justify-content: center; }
            .view-buttons { justify-content: center; }
            .month-label { font-size: 1.3rem; }

            .calendar-day { min-height: 80px; padding: 6px; }
            .day-number { font-size: 0.8rem; margin-bottom: 4px; }
            .lesson-mini { padding: 4px 6px; font-size: 0.65rem; }
            .lesson-mini .lesson-info { display: none; }

            .lesson-list-item {
                grid-template-columns: 60px 1fr;
                gap: 12px;
            }
            .list-time { display: none; }

            .module-header { grid-template-columns: auto 1fr auto; gap: 12px; padding: 16px 20px; }
            .module-number { width: 44px; height: 44px; font-size: 1.1rem; }
            .module-title-section h3 { font-size: 1rem; }
            .module-section { padding: 20px; }

            .syllabus-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-top">
                <a href="/index.html" class="back-link">‚Üê Torna al sito</a>
                <h1>Master in Carbon Farming</h1>
            </div>
            <div class="main-tabs">
                <button id="tab-calendario" class="active">Calendario</button>
                <button id="tab-syllabus">Syllabus</button>
            </div>
        </div>
    </header>

    <main>
        <!-- ============ TAB CALENDARIO ============ -->
        <div id="content-calendario" class="tab-content active">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button id="prev-month">‚Üê</button>
                    <span class="month-label" id="month-label"></span>
                    <button id="next-month">‚Üí</button>
                </div>
                <div class="view-buttons">
                    <button id="btn-grid" class="active">Griglia</button>
                    <button id="btn-list">Lista</button>
                </div>
            </div>

            <div class="calendar-container" id="calendar-container">
                <div class="weekdays">
                    <div>Luned√¨</div>
                    <div>Marted√¨</div>
                    <div>Mercoled√¨</div>
                    <div>Gioved√¨</div>
                    <div>Venerd√¨</div>
                    <div>Sabato</div>
                    <div>Domenica</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <div class="list-container" id="list-container"></div>
        </div>

        <!-- ============ TAB SYLLABUS ============ -->
        <div id="content-syllabus" class="tab-content">
            <div class="syllabus-intro">
                <h2>Piano Didattico del Master</h2>
                <p>Il Master in Carbon Farming offre una formazione completa sulle strategie di sequestro del carbonio in agricoltura e silvicoltura, combinando competenze scientifiche, tecniche e normative per formare professionisti della transizione ecologica.</p>
                <div class="syllabus-stats">
                    <div class="stat-box">
                        <div class="number" id="stat-modules">-</div>
                        <div class="label">Moduli</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="stat-cfu">60</div>
                        <div class="label">CFU</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="stat-hours">1500</div>
                        <div class="label">Ore totali</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="stat-lessons">-</div>
                        <div class="label">Lezioni</div>
                    </div>
                </div>
            </div>

            <div class="modules-grid" id="modules-grid">
                <!-- Modules will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <button class="modal-close" id="modal-close">√ó</button>
            <div class="modal-header">
                <span class="modal-module-badge" id="modal-module"></span>
                <h2 class="modal-title" id="modal-title"></h2>
            </div>
            <div class="modal-body">
                <div class="modal-datetime">
                    <div class="modal-datetime-item">
                        <span>üìÖ</span>
                        <span id="modal-date"></span>
                    </div>
                    <div class="modal-datetime-item">
                        <span>‚è∞</span>
                        <span id="modal-time"></span>
                    </div>
                </div>
                <div class="modal-details">
                    <div class="modal-detail-row" id="modal-teacher-row">
                        <span class="icon">üë§</span>
                        <div class="content">
                            <div class="label">Docente</div>
                            <div class="value" id="modal-teacher"></div>
                        </div>
                    </div>
                    <div class="modal-detail-row" id="modal-location-row">
                        <span class="icon">üìç</span>
                        <div class="content">
                            <div class="label">Luogo</div>
                            <div class="value" id="modal-location"></div>
                        </div>
                    </div>
                    <div class="modal-detail-row" id="modal-remote-row">
                        <span class="icon">üíª</span>
                        <div class="content">
                            <div class="label">Lezione Online</div>
                            <div class="value" id="modal-remote"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-description" id="modal-description-section">
                    <h4>Descrizione</h4>
                    <p id="modal-description"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const state = {
            year: new Date().getFullYear(),
            month: new Date().getMonth(),
            lessons: [],
            modules: [],
            view: 'grid',
            tab: 'calendario'
        };

        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                           'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const weekdayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];

        // Module colors based on sort order
        function getModuleClass(moduleIndex) {
            const classes = ['m1', 'm2', 'm3', 'm4'];
            return classes[moduleIndex % classes.length] || 'm1';
        }

        function getModuleColorClass(moduleName, moduleId) {
            // Get module index from modules array
            const idx = state.modules.findIndex(m => m.id === moduleId);
            if (idx >= 0) return 'module-' + (idx % 4 + 1);
            return 'module-default';
        }

        async function loadModules() {
            try {
                const res = await fetch('/api/modules');
                if (!res.ok) throw new Error();
                state.modules = await res.json();
                document.getElementById('stat-modules').textContent = state.modules.length;
                renderSyllabus();
            } catch (e) {
                state.modules = [];
            }
        }

        async function loadLessons() {
            try {
                const params = new URLSearchParams();
                params.set('year', state.year);
                params.set('month', state.month + 1);
                const res = await fetch(`/api/lessons?${params.toString()}`);
                if (!res.ok) throw new Error();
                state.lessons = (await res.json()).filter(l => l.status !== 'draft');
                render();
            } catch (e) {
                state.lessons = [];
                render();
            }
        }

        async function loadAllLessons() {
            try {
                const res = await fetch('/api/lessons');
                if (!res.ok) throw new Error();
                const all = (await res.json()).filter(l => l.status !== 'draft');
                document.getElementById('stat-lessons').textContent = all.length;
                return all;
            } catch (e) {
                return [];
            }
        }

        function render() {
            document.getElementById('month-label').textContent = `${monthNames[state.month]} ${state.year}`;
            if (state.view === 'grid') {
                renderCalendar();
            } else {
                renderList();
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const firstDay = new Date(state.year, state.month, 1);
            const lastDay = new Date(state.year, state.month + 1, 0);
            const startDayOfWeek = (firstDay.getDay() + 6) % 7;
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Previous month
            const prevMonth = new Date(state.year, state.month, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                grid.appendChild(createDayCell(prevMonth.getDate() - i, true));
            }

            // Current month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${state.year}-${String(state.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const dayLessons = state.lessons.filter(l =>
                    new Date(l.startDatetime).toISOString().split('T')[0] === dateStr
                );
                grid.appendChild(createDayCell(day, false, dayLessons, isToday));
            }

            // Next month
            const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
            for (let i = 1; i <= totalCells - startDayOfWeek - daysInMonth; i++) {
                grid.appendChild(createDayCell(i, true));
            }
        }

        function createDayCell(dayNum, isOther, lessons = [], isToday = false) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (isOther) cell.classList.add('other-month');
            if (isToday) cell.classList.add('today');

            let lessonsHtml = '';
            if (lessons.length > 0) {
                lessonsHtml = '<div class="day-lessons">';
                const show = lessons.slice(0, 3);
                show.forEach(l => {
                    const time = new Date(l.startDatetime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    const moduleIdx = state.modules.findIndex(m => m.id === l.moduleId);
                    const colorClass = moduleIdx >= 0 ? `module-${moduleIdx % 4 + 1}` : 'module-default';
                    lessonsHtml += `
                        <div class="lesson-mini ${colorClass}" onclick="showModal('${l.id}')">
                            <div class="lesson-time">${time}</div>
                            <div class="lesson-title">${l.title}</div>
                            <div class="lesson-info">
                                ${l.moduleName ? `<span>${l.moduleName.split(' ')[0]}</span>` : ''}
                                ${l.teacherName ? `<span>${l.teacherName.split(' ').pop()}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                if (lessons.length > 3) {
                    lessonsHtml += `<div class="more-indicator">+${lessons.length - 3} altre</div>`;
                }
                lessonsHtml += '</div>';
            }

            const dayNumHtml = isToday
                ? `<div class="day-number"><span>${dayNum}</span></div>`
                : `<div class="day-number">${dayNum}</div>`;

            cell.innerHTML = dayNumHtml + lessonsHtml;
            return cell;
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const sorted = [...state.lessons]
                .filter(l => l.status !== 'cancelled')
                .sort((a, b) => new Date(a.startDatetime) - new Date(b.startDatetime));

            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessuna lezione questo mese</h3>
                        <p>Naviga nei mesi successivi per vedere le lezioni programmate.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sorted.map(lesson => {
                const date = new Date(lesson.startDatetime);
                const timeStr = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const endTime = new Date(date.getTime() + (lesson.durationMinutes || 120) * 60000);
                const endTimeStr = endTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const moduleIdx = state.modules.findIndex(m => m.id === lesson.moduleId);
                const badgeClass = moduleIdx >= 0 ? `m${moduleIdx % 4 + 1}` : '';

                return `
                    <div class="lesson-list-item" onclick="showModal('${lesson.id}')">
                        <div class="list-date">
                            <div class="day">${date.getDate()}</div>
                            <div class="weekday">${weekdayNames[date.getDay()]}</div>
                        </div>
                        <div class="list-info">
                            ${lesson.moduleName ? `<span class="module-badge ${badgeClass}">${lesson.moduleName}</span>` : ''}
                            <h3>${lesson.title}</h3>
                            <div class="list-meta">
                                <span>‚è∞ ${timeStr} - ${endTimeStr}</span>
                                ${lesson.teacherName ? `<span>üë§ ${lesson.teacherName}</span>` : ''}
                                ${lesson.locationPhysical ? `<span>üìç ${lesson.locationPhysical}</span>` : ''}
                            </div>
                        </div>
                        <div class="list-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }

        async function renderSyllabus() {
            const container = document.getElementById('modules-grid');
            const allLessons = await loadAllLessons();

            if (state.modules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun modulo definito</h3>
                        <p>I moduli del Master saranno pubblicati prossimamente.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.modules.map((mod, idx) => {
                const colorClass = getModuleClass(idx);
                const moduleLessons = allLessons.filter(l => l.moduleId === mod.id)
                    .sort((a, b) => new Date(a.startDatetime) - new Date(b.startDatetime));

                // Get unique teachers for this module
                const teachers = [...new Set(moduleLessons.filter(l => l.teacherName).map(l => l.teacherName))];

                return `
                    <div class="module-card" id="module-${mod.id}">
                        <div class="module-header" onclick="toggleModule('${mod.id}')">
                            <div class="module-number ${colorClass}">M${idx + 1}</div>
                            <div class="module-title-section">
                                <h3>${mod.name}</h3>
                                <div class="module-meta">
                                    ${teachers.length > 0 ? `<span>üë§ ${teachers.join(', ')}</span>` : ''}
                                    <span>üìö ${moduleLessons.length} lezioni</span>
                                </div>
                            </div>
                            <button class="module-toggle">‚ñº</button>
                        </div>
                        <div class="module-content">
                            ${mod.description ? `
                                <div class="module-section">
                                    <h4>Descrizione</h4>
                                    <p>${mod.description}</p>
                                </div>
                            ` : ''}
                            ${teachers.length > 0 ? `
                                <div class="module-section">
                                    <h4>Docenti</h4>
                                    <div class="teachers-list">
                                        ${teachers.map(t => `
                                            <div class="teacher-tag">
                                                <div class="avatar">${t.split(' ').map(n => n[0]).join('').substring(0, 2)}</div>
                                                <span class="name">${t}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${moduleLessons.length > 0 ? `
                                <div class="module-section module-lessons">
                                    <h4>Calendario Lezioni</h4>
                                    ${moduleLessons.map(l => {
                                        const d = new Date(l.startDatetime);
                                        const time = d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                                        return `
                                            <div class="module-lesson-item" onclick="showModal('${l.id}')">
                                                <div class="lesson-date-badge">
                                                    <div class="day">${d.getDate()}</div>
                                                    <div class="month">${monthNames[d.getMonth()].substring(0, 3)}</div>
                                                </div>
                                                <div class="lesson-details">
                                                    <div class="title">${l.title}</div>
                                                    <div class="meta">
                                                        <span>‚è∞ ${time}</span>
                                                        ${l.teacherName ? `<span>üë§ ${l.teacherName}</span>` : ''}
                                                        ${l.locationPhysical ? `<span>üìç ${l.locationPhysical}</span>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleModule(id) {
            const card = document.getElementById(`module-${id}`);
            card.classList.toggle('expanded');
        }

        function showModal(lessonId) {
            const lesson = state.lessons.find(l => l.id === lessonId);
            if (!lesson) return;

            const date = new Date(lesson.startDatetime);
            const dateStr = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            const endTime = new Date(date.getTime() + (lesson.durationMinutes || 120) * 60000);
            const endTimeStr = endTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

            const moduleIdx = state.modules.findIndex(m => m.id === lesson.moduleId);
            const badgeClass = moduleIdx >= 0 ? `m${moduleIdx % 4 + 1}` : '';

            const moduleEl = document.getElementById('modal-module');
            moduleEl.textContent = lesson.moduleName || '';
            moduleEl.className = 'modal-module-badge module-badge ' + badgeClass;
            moduleEl.style.display = lesson.moduleName ? '' : 'none';

            document.getElementById('modal-title').textContent = lesson.title;
            document.getElementById('modal-date').textContent = dateStr;
            document.getElementById('modal-time').textContent = `${timeStr} - ${endTimeStr}`;

            document.getElementById('modal-teacher').textContent = lesson.teacherName || '';
            document.getElementById('modal-teacher-row').style.display = lesson.teacherName ? '' : 'none';

            document.getElementById('modal-location').textContent = lesson.locationPhysical || '';
            document.getElementById('modal-location-row').style.display = lesson.locationPhysical ? '' : 'none';

            if (lesson.locationRemote) {
                document.getElementById('modal-remote').innerHTML = `<a href="${lesson.locationRemote}" target="_blank">Accedi alla lezione ‚Üí</a>`;
                document.getElementById('modal-remote-row').style.display = '';
            } else {
                document.getElementById('modal-remote-row').style.display = 'none';
            }

            const descSection = document.getElementById('modal-description-section');
            if (lesson.description) {
                document.getElementById('modal-description').textContent = lesson.description;
                descSection.style.display = '';
            } else {
                descSection.style.display = 'none';
            }

            document.getElementById('modal-overlay').classList.add('active');
        }

        window.showModal = showModal;
        window.toggleModule = toggleModule;

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // Tab navigation
        document.getElementById('tab-calendario').addEventListener('click', () => {
            state.tab = 'calendario';
            document.getElementById('tab-calendario').classList.add('active');
            document.getElementById('tab-syllabus').classList.remove('active');
            document.getElementById('content-calendario').classList.add('active');
            document.getElementById('content-syllabus').classList.remove('active');
        });

        document.getElementById('tab-syllabus').addEventListener('click', () => {
            state.tab = 'syllabus';
            document.getElementById('tab-syllabus').classList.add('active');
            document.getElementById('tab-calendario').classList.remove('active');
            document.getElementById('content-syllabus').classList.add('active');
            document.getElementById('content-calendario').classList.remove('active');
            renderSyllabus();
        });

        // Calendar navigation
        document.getElementById('prev-month').addEventListener('click', () => {
            state.month--;
            if (state.month < 0) { state.month = 11; state.year--; }
            loadLessons();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            state.month++;
            if (state.month > 11) { state.month = 0; state.year++; }
            loadLessons();
        });

        // View toggle
        document.getElementById('btn-grid').addEventListener('click', () => {
            state.view = 'grid';
            document.getElementById('btn-grid').classList.add('active');
            document.getElementById('btn-list').classList.remove('active');
            document.getElementById('calendar-container').classList.remove('hidden');
            document.getElementById('list-container').classList.remove('active');
            render();
        });

        document.getElementById('btn-list').addEventListener('click', () => {
            state.view = 'list';
            document.getElementById('btn-list').classList.add('active');
            document.getElementById('btn-grid').classList.remove('active');
            document.getElementById('calendar-container').classList.add('hidden');
            document.getElementById('list-container').classList.add('active');
            render();
        });

        // Modal close
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') closeModal();
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        // Init
        loadModules();
        loadLessons();
    </script>
</body>
</html>
